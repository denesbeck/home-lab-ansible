---
- name: Install and configure Samba
  hosts: all
  become: yes
  tasks:
    - import_tasks: ../tasks/update-packages.yml

    - name: Install Samba package
      apt:
        name: samba
        state: present
        update_cache: yes

    - name: Create samba user and group
      user:
        name: smbuser
        state: present
        create_home: no

    - name: Create samba group
      group:
        name: smbgroup
        state: present

    - name: Backup current smb.conf
      copy:
        src: /etc/samba/smb.conf
        dest: "/etc/samba/smb.conf.bak.{{ ansible_date_time.date | replace('-', '') }}{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}{{ ansible_date_time.second }}"
        remote_src: yes
        backup: yes
      when: ansible_facts['os_family'] == "Debian"

    - name: Configure smb.conf with custom settings
      template:
        src: ../config/smb.conf.j2
        dest: /etc/samba/smb.conf
      notify:
        - Restart samba

  handlers:
    - name: Restart samba
      service:
        name: smbd
        state: restarted
